#!/bin/bash -e

sql="
set client_min_messages to warning;

create table if not exists migrations (
  id varchar(255) primary key
);
"

for file in $(ls ./migrate); do
  id=${file%.*}
  sql+="
  do \$\$
  begin
    if not exists(select 1 from migrations where id ='$id') then
      insert into migrations (id) values ('$id');
      $(cat ./migrate/$file)
    end if;
  end
  \$\$;"
done

psql --quiet $DATABASE_URL <<< "$sql"
